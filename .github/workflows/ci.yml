name: ci
on:
  push:
    branches:
      - main
  pull_request:
  workflow_dispatch:
jobs:
  test:
    runs-on: ubuntu-latest
    concurrency: deploy-group
    steps:
      - uses: actions/checkout@v4
      - uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.toml') }}
      - run: rustup update stable
      - run: rustup default stable
      - run: cargo test
      - run: cargo install --debug jas@0.3.0
      - run: >
          jas install
          --gh casey/just@1.40.0
          --sha 181b91d0ceebe8a57723fb648ed2ce1a44d849438ce2e658339df4f8db5f1263
          --gh-token ${{ secrets.GITHUB_TOKEN }}
      - run: >
          jas install
          --gh superfly/flyctl@v0.3.102
          --sha 2894ca44760b47544aa9e07e3bf403f1d77fb7c0f5b62985e7b36805528b03d4
          --gh-token ${{ secrets.GITHUB_TOKEN }}
      - run: just release
  
  deploy:
    needs: test
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4
      - uses: docker/login-action@ec9cdf07d570632daeb912f5b2099cb9ec1d01e6
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@3343011071fa59c64a174cc6aa415dc13b31b7b2
        with:
          images: rikhuijzer/fx
      - run: cargo install --debug jas@0.3.0
      - run: >
          jas install
          --gh casey/just@1.40.0
          --sha d065d0df1a1f99529869fba8a5b3e0a25c1795b9007099b00dfabe29c7c1f7b6
          --gh-token ${{ secrets.GITHUB_TOKEN }}
      - run: just release
      - name: Build and push Docker image
        uses: docker/build-push-action@d63c96254b2c3dce2a3e8745f423cf62caafb13a
        with:
          context: .
          push: github.event_name != 'pull_request'
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
